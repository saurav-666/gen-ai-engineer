<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1 id="heading">A Basic Chatbot</h1>
    <div class="container">
        <input type="text" id="user-input" placeholder="What do you want to know?">
        <button id="send-button" onclick="sendMessage()">Send</button>
        <div class="chat-container">
            <div id="chat-output" class="chat-output-normal"></div>
            <img id="chat-image" src="../static/images/jolly-roger-pirate-flag.jpg" alt="The Jolly Roger" class="invisible"/>
        </div>
    </div>

    <script>
    document.getElementById("user-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault(); // Prevent the default action (form submission)
            document.getElementById("send-button").click(); // Trigger the button click
        }
    });

    function swapStylesAndHeading() {
        const heading = document.getElementById("heading");
        heading.style.color = "blue";
        heading.style.fontSize = "2em";
        heading.innerHTML = "<strike>Chatbot</strike> Pirate Bot. Arrr...";
        const userInput = document.getElementById("user-input");
        userInput.style.backgroundColor = "lightblue";
        userInput.style.color = "darkblue";
        userInput.placeholder = "What do ye want to know?";
        const chatOutput = document.getElementById("chat-output");
        chatOutput.classList.remove("chat-output-normal");
        chatOutput.classList.add("chat-output");
        const chatImage = document.getElementById("chat-image");
        chatImage.classList.remove("invisible");
        chatImage.classList.add("visible");
    }

    function sendMessage() {
        const userInput = document.getElementById("user-input").value;
        console.log("Sending message:", userInput);

        if (userInput.placeholder != "What do ye want to know?") {
            swapStylesAndHeading();
        }   

        // First, send the user input to the backend using POST
        fetch("/submit", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ input: userInput }),
        }).then(response => {
            if (response.ok) {
                console.log("Message sent successfully");
                // After submission, start the stream
                const chatOutput = document.getElementById("chat-output");
                const eventSource = new EventSource('/stream');
                eventSource.onmessage = function(event) {
                    if (event.data === "[END]") {
                        // Close the EventSource connection when the end message is received
                        eventSource.close();
                    } else {
                        chatOutput.innerHTML += `${event.data}`;
                    }
                };
            } else {
                console.error("Error sending message");
            }
        }).catch(error => console.error("Error:", error));
    }
    </script>
</body>
</html>